# .github/workflows/teleport-deploy.yaml
name: Teleport File Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      target_server:
        description: 'Target server (overrides server.txt)'
        required: false
        type: string
      cluster:
        description: 'Teleport cluster name'
        required: false
        default: 'iad0'
        type: string
      target_path:
        description: 'Target path on server'
        required: false
        default: '/tmp'
        type: string
      files_to_copy:
        description: 'Files/patterns to copy (space-separated)'
        required: false
        default: 'config/*.json'
        type: string

jobs:
  teleport-deploy:
    runs-on: ubuntu-latest
    # For local execution with act, this will run on your MacBook
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Display deployment info
        run: |
          echo "========================================"
          echo "Teleport File Deployment"
          echo "========================================"
          echo "Trigger: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Target Server: ${{ github.event.inputs.target_server }}"
            echo "Target Path: ${{ github.event.inputs.target_path }}"
            echo "Files to Copy: ${{ github.event.inputs.files_to_copy }}"
          fi
          echo "========================================"


      - name: Read server configuration
        id: server-config
        run: |
          echo "========================================"
          echo "Reading server configuration"
          echo "========================================"
          
          # Read server from server.txt (first non-comment, non-empty line)
          SERVER=$(grep -v '^#' server.txt | grep -v '^[[:space:]]*$' | head -1 | xargs)
          
          # Override with workflow input if provided
          if [ -n "${{ github.event.inputs.target_server }}" ]; then
            SERVER="${{ github.event.inputs.target_server }}"
            echo "Using workflow input server: $SERVER"
          else
            echo "Using server from server.txt: $SERVER"
          fi
          
          # Set cluster (default to iad0 for Netskope)
          CLUSTER="${{ github.event.inputs.cluster }}"
          if [ -z "$CLUSTER" ]; then
            CLUSTER="iad0"
          fi
          
          # Set target path
          TARGET_PATH="${{ github.event.inputs.target_path }}"
          if [ -z "$TARGET_PATH" ]; then
            TARGET_PATH="/tmp"
          fi
          
          # Set files to copy
          FILES_TO_COPY="${{ github.event.inputs.files_to_copy }}"
          if [ -z "$FILES_TO_COPY" ]; then
            FILES_TO_COPY="config/*.json"
          fi
          
          echo "server=$SERVER" >> $GITHUB_OUTPUT
          echo "cluster=$CLUSTER" >> $GITHUB_OUTPUT
          echo "target_path=$TARGET_PATH" >> $GITHUB_OUTPUT
          echo "files_to_copy=$FILES_TO_COPY" >> $GITHUB_OUTPUT
          
          echo ""
          echo "Configuration:"
          echo "  Cluster: $CLUSTER"
          echo "  Server: $SERVER"
          echo "  Target Path: $TARGET_PATH"
          echo "  Files: $FILES_TO_COPY"
          echo "========================================"

      - name: Install Teleport
        run: |
          echo "========================================"
          echo "Installing Teleport (tsh)"
          echo "========================================"
          
          if command -v tsh &> /dev/null; then
            echo "‚úì Teleport is already installed"
            tsh version
          else
            echo "Installing Teleport..."
            
            # Detect OS and install accordingly
            if [[ "$OSTYPE" == "darwin"* ]]; then
              # macOS
              if command -v brew &> /dev/null; then
                brew install teleport
              else
                echo "‚ö†Ô∏è  Homebrew not found. Installing via curl..."
                curl -O https://cdn.teleport.dev/teleport-v15.4.29-darwin-amd64.tar.gz
                tar -xzf teleport-v15.4.29-darwin-amd64.tar.gz
                sudo cp teleport/tsh /usr/local/bin/
                rm -rf teleport teleport-v15.4.29-darwin-amd64.tar.gz
              fi
            else
              # Linux (Ubuntu/Debian)
              echo "Installing Teleport on Linux..."
              curl https://goteleport.com/static/install.sh | bash -s 15.4.29
            fi
            
            echo "‚úì Teleport installed successfully"
            tsh version
          fi
          echo "========================================"
      
      - name: Configure Teleport
        env:
          TELEPORT_PROXY: ${{ secrets.TELEPORT_PROXY || 'teleport.netskope.io:443' }}
          TELEPORT_TOKEN: ${{ secrets.TELEPORT_TOKEN }}
          TELEPORT_USER: ${{ secrets.TELEPORT_USER }}
        run: |
          echo "========================================"
          echo "Configuring Teleport"
          echo "========================================"
          
          # Check if running locally with existing session
          if tsh status &> /dev/null; then
            echo "‚úì Using existing Teleport session"
            tsh status
          else
            echo "No active Teleport session"
            echo ""
            echo "For local execution with act:"
            echo "  1. Login manually: tsh login --proxy=$TELEPORT_PROXY"
            echo "  2. Mount credentials: act -v \$HOME/.tsh:/root/.tsh:ro"
            echo ""
            echo "For GitHub Actions, configure secrets:"
            echo "  - TELEPORT_PROXY"
            echo "  - TELEPORT_TOKEN (identity file or certificate)"
            echo "  - TELEPORT_USER"
          fi
          echo "========================================"

      - name: Prepare deployment package
        run: |
          echo "========================================"
          echo "Preparing deployment package"
          echo "========================================"
          
          mkdir -p deploy/config deploy/build
          
          # Copy files
          if [ -d "config" ]; then
            cp -v config/*.json deploy/config/ 2>/dev/null || echo "No JSON files in config/"
          fi
          
        
          
          # Create deployment info
          cat > deploy/DEPLOY_INFO.txt << EOF
          Deployment Information
          ======================
          Timestamp: $(date -u)
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Trigger: ${{ github.event_name }}
          
          Files in package:
          EOF
          
          find deploy -type f >> deploy/DEPLOY_INFO.txt
          
          echo ""
          echo "Deployment package ready:"
          find deploy -type f
          echo "========================================"

      - name: Deploy via Teleport (tsh scp)
        env:
          TARGET_SERVER: ${{ steps.server-config.outputs.server }}
          TARGET_PATH: ${{ steps.server-config.outputs.target_path }}
          CLUSTER: ${{ steps.server-config.outputs.cluster }}
        run: |
          echo "========================================"
          echo "Deploying files via Teleport"
          echo "========================================"
          echo "Cluster: $CLUSTER"
          echo "Target: $TARGET_SERVER:$TARGET_PATH"
          echo ""
          
          if ! command -v tsh &> /dev/null; then
            echo "‚ùå Error: Teleport (tsh) not installed"
            echo "========================================"
            exit 1
          fi
          
          # Check if logged in to Teleport
          if ! tsh status &> /dev/null; then
            echo "‚ö†Ô∏è  Not logged in to Teleport"
            echo ""
            echo "For local execution with act:"
            echo "  Run: act -v \$HOME/.tsh:/root/.tsh:ro -W .github/workflows/teleport-deploy.yaml"
            echo ""
            echo "Or login before running:"
            echo "  tsh login --proxy=teleport.netskope.io:443"
            echo ""
            echo "Simulating deployment (files would be copied):"
            find deploy -type f
            echo "========================================"
            exit 0
          fi
          
          echo "‚úì Logged in to Teleport"
          echo ""
          echo "Copying files to $TARGET_SERVER (cluster: $CLUSTER)..."
          
          # Create target directory on remote server first
          echo ""
          echo "üìÅ Creating remote directory..."
          if tsh ssh --cluster "$CLUSTER" "nagaaravindb@$TARGET_SERVER" "mkdir -p $TARGET_PATH/github-action-test && chmod 755 $TARGET_PATH/github-action-test" 2>&1; then
            echo "‚úì Directory created/verified"
          else
            echo "‚ùå Failed to create remote directory"
            exit 1
          fi
          
          # Copy configuration files
          if [ -d "deploy/config" ] && [ "$(ls -A deploy/config 2>/dev/null)" ]; then
            echo ""
            echo "üìÅ Copying config files..."
            if tsh scp --cluster "$CLUSTER" -r deploy/config "nagaaravindb@$TARGET_SERVER:$TARGET_PATH/github-action-test/" 2>&1; then
              echo "‚úì Config files copied"
            else
              echo "‚ùå Failed to copy config files"
              exit 1
            fi
          fi
          
          echo ""
          echo "‚úì Deployment completed successfully!"
          echo ""
          echo "Verifying files on remote server..."
          tsh ssh --cluster "$CLUSTER" "nagaaravindb@$TARGET_SERVER" "ls -laR /tmp/github-action-test" || echo "Could not verify (non-critical)"
          
          echo "========================================"

      - name: Deployment summary
        env:
          CLUSTER: ${{ steps.server-config.outputs.cluster }}
        run: |
          echo "========================================"
          echo "Deployment Summary"
          echo "========================================"
          echo "‚úì Build completed"
          echo "‚úì Deployment package prepared"
          echo "‚úì Files copied to: $TARGET_SERVER:$TARGET_PATH"

          echo "========================================"
